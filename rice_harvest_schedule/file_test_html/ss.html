<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Service Areas</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .table-container {
            max-height: 400px; /* Adjust the max height as needed */
            overflow-y: auto;
        }
        .truncate-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px; /* Adjust the max width as needed */
            cursor: pointer;
        }
    </style>
</head>
<body style="font-family: 'K2D', sans-serif;">


    <div class="max-w-screen-sm mx-auto p-4 bg-white mt-5 mb-10 rounded-lg shadow-md border border-gray-500 border-2">
        <h2 class="text-xl font-bold mb-4">เพิ่มข้อมูลพื้นที่</h2>
        <form id="service-area-form">
            <input type="hidden" id="edit-index" />
            <div class="mb-4">
                <label class="block mb-2 text-sm font-medium text-gray-700">วันเริ่มต้น :</label>
                <input type="date" id="start-date" name="start-date" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring focus:border-blue-300" required />
            </div>
            <div class="mb-4">
                <label class="block mb-2 text-sm font-medium text-gray-700">วันสิ้นสุด :</label>
                <input type="date" id="end-date" name="end-date" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring focus:border-blue-300" required />
            </div>
            <div class="mb-4">
                <label for="province" class="block mb-2 text-sm font-medium text-gray-700">จังหวัด :</label>
                <select id="province" name="province" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring focus:border-blue-300" required>
                    <option value="">เลือกจังหวัด</option>
                    <!-- Provinces will be populated dynamically -->
                </select>
            </div>
            <div class="mb-4">
                <label class="block mb-2 text-sm font-medium text-gray-700">อำเภอ :</label>
                <select id="district" name="district" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring focus:border-blue-300" required>
                    <option value="">เลือกอำเภอ</option>
                    <!-- Districts will be populated dynamically -->
                </select>
            </div>
            <div class="mb-4">
                <label class="block mb-2 text-sm font-medium text-gray-700">ตำบล :</label>
                <div id="subdistrict-checkboxes" class="border rounded-md p-2">
                    <!-- Subdistrict checkboxes will be populated dynamically -->
                </div>
            </div>
            <div class="mb-4">
                <label class="block mb-2 text-sm font-medium text-gray-700">รายละเอียด :</label>
                <textarea id="details" name="details" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring focus:border-blue-300" rows="3"></textarea>
            </div>
            <div class="flex justify-between">
                <button type="button" id="cancel-button" class="px-4 py-2 font-bold text-white bg-red-500 rounded-md hover:bg-red-700 focus:outline-none focus:ring focus:border-red-300">ยกเลิก</button>
                <button type="submit" class="px-4 py-2 font-bold text-white bg-blue-500 rounded-md hover:bg-blue-700 focus:outline-none focus:ring focus:border-blue-300">เพิ่มข้อมูล</button>
            </div>
        </form>
    </div>

    <div class="max-w-screen-md mx-auto p-4 bg-white mt-5 mb-10 rounded-lg shadow-md border border-gray-500 border-2">
        <h2 class="text-xl font-bold mb-4">พื้นที่ลงเก็บเกี่ยว</h2>
        <div class="table-container">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วัน เดือน</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สถานที่</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รายละเอียด</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การจัดการ</th>
                    </tr>
                </thead>
                <tbody id="service-areas-list" class="bg-white divide-y divide-gray-200">
                    <!-- Rows will be added dynamically here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <div id="info-modal" class="fixed z-10 inset-0 overflow-y-auto hidden">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div>
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500" id="modal-content"></p>
                    </div>
                </div>
                <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                    <button type="button" id="close-modal" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        $(document).ready(function(){
            let provinces, districts, subdistricts;

            // Load JSON data
            $.when(
                $.getJSON('https://raw.githubusercontent.com/thailand-geography-data/thailand-geography-json/main/src/provinces.json', function(data) { provinces = data; }),
                $.getJSON('https://raw.githubusercontent.com/thailand-geography-data/thailand-geography-json/main/src/districts.json', function(data) { districts = data; }),
                $.getJSON('https://raw.githubusercontent.com/thailand-geography-data/thailand-geography-json/main/src/subdistricts.json', function(data) { subdistricts = data; })
            ).then(function() {
                // ตรวจสอบข้อมูลที่ดึงมา
                console.log(provinces);
                console.log(districts);
                console.log(subdistricts);

                // Populate province select box
                let provinceSelect = $('#province');
                provinces.forEach(function(province) {
                    provinceSelect.append(new Option(province.provinceNameTh, province.provinceCode));
                });

                // On province change
                $('#province').change(function() {
                    let provinceId = $(this).val();
                    if (provinceId) {
                        let filteredDistricts = districts.filter(d => d.provinceCode == provinceId);
                        let districtSelect = $('#district');
                        districtSelect.empty().append(new Option('เลือกอำเภอ', ''));
                        filteredDistricts.forEach(function(district) {
                            districtSelect.append(new Option(district.districtNameTh, district.districtCode));
                        });
                        $('#district').prop('disabled', false);
                    } else {
                        $('#district').empty().append(new Option('เลือกอำเภอ', '')).prop('disabled', true);
                        $('#subdistrict-checkboxes').empty().prop('disabled', true);
                    }
                });

                // On district change
                $('#district').change(function() {
                    let districtId = $(this).val();
                    if (districtId) {
                        let filteredSubdistricts = subdistricts.filter(s => s.districtCode == districtId);
                        let subdistrictCheckboxes = $('#subdistrict-checkboxes');
                        subdistrictCheckboxes.empty();
                        filteredSubdistricts.forEach(function(subdistrict) {
                            subdistrictCheckboxes.append(`
                                <div class="flex items-center mb-2">
                                    <input type="checkbox" id="subdistrict-${subdistrict.subdistrictCode}" name="subdistricts" value="${subdistrict.subdistrictNameTh}" class="mr-2">
                                    <label for="subdistrict-${subdistrict.subdistrictCode}" class="text-sm text-gray-700">${subdistrict.subdistrictNameTh}</label>
                                </div>
                            `);
                        });
                        $('#subdistrict-checkboxes').prop('disabled', false);
                    } else {
                        $('#subdistrict-checkboxes').empty().prop('disabled', true);
                    }
                });
            });

            $('#service-area-form').submit(function(event) {
                event.preventDefault();

                let editIndex = $('#edit-index').val();

                // Collect form data
                let startDate = $('#start-date').val();
                let endDate = $('#end-date').val();
                let province = $('#province option:selected').text();
                let district = $('#district option:selected').text();
                let selectedSubdistricts = [];
                $('#subdistrict-checkboxes input[name="subdistricts"]:checked').each(function() {
                    selectedSubdistricts.push($(this).val());
                });
                let subdistrict = selectedSubdistricts.join(', ');
                let details = $('#details').val();

                let rowHtml = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${startDate} - ${endDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate-text" data-fulltext="จ.${province}, อ.${district}, ต.${subdistrict}">จ.${province}, อ.${district}, ต.${subdistrict}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate-text" data-fulltext="${details}">${details}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <button class="text-blue-600 hover:text-blue-900 edit-button">แก้ไข</button>
                            <button class="text-red-600 hover:text-red-900 delete-button">ลบ</button>
                        </td>
                    </tr>
                `;

                if (editIndex) {
                    // Update existing row
                    $('#service-areas-list tr').eq(editIndex).replaceWith(rowHtml);
                } else {
                    // Add new row to the table
                    $('#service-areas-list').append(rowHtml);
                }

                // Clear form fields and edit index
                $('#service-area-form')[0].reset();
                $('#edit-index').val('');
                $('#district').empty().append(new Option('เลือกอำเภอ', '')).prop('disabled', true);
                $('#subdistrict-checkboxes').empty().prop('disabled', true);
            });

            // Delete row
            $('#service-areas-list').on('click', '.delete-button', function() {
                $(this).closest('tr').remove();
            });

            // Edit row
            $('#service-areas-list').on('click', '.edit-button', function() {
                let row = $(this).closest('tr');
                let cells = row.children('td');

                let dates = cells.eq(0).text().split(' - ');
                let startDate = dates[0].trim();
                let endDate = dates[1].trim();

                let location = cells.eq(1).data('fulltext').split(', ');
                let province = location[0].trim().replace('จ.', '');
                let district = location[1].trim().replace('อ.', '');
                let subdistrict = location.slice(2).join(', ').trim().replace('ต.', '');
                let details = cells.eq(2).data('fulltext').trim();

                $('#start-date').val(startDate);
                $('#end-date').val(endDate);
                $('#province').val(province).change();
                $('#district').val(district).change();

                setTimeout(() => {
                    $('#subdistrict-checkboxes input[name="subdistricts"]').each(function() {
                        if (subdistrict.split(', ').includes($(this).val())) {
                            $(this).prop('checked', true);
                        }
                    });
                }, 500);

                $('#details').val(details);
                $('#edit-index').val(row.index());
            });

            // Show full text on click
            $('#service-areas-list').on('click', '.truncate-text', function() {
                let fullText = $(this).data('fulltext');
                $('#modal-title').text('ข้อมูลเพิ่มเติม');
                $('#modal-content').text(fullText);
                $('#info-modal').removeClass('hidden');
            });

            // Close modal
            $('#close-modal').click(function() {
                $('#info-modal').addClass('hidden');
            });

            // Cancel button action
            $('#cancel-button').click(function() {
                $('#service-area-form')[0].reset();
                $('#edit-index').val('');
                $('#district').empty().append(new Option('เลือกอำเภอ', '')).prop('disabled', true);
                $('#subdistrict-checkboxes').empty().prop('disabled', true);
            });
        });
    </script>
</body>
</html>
